<?xml version="1.0" encoding="UTF-8" ?>
<odoo>

  <template id="report_template_prescription">
    <t t-call="web.html_container">
      <t t-foreach="docs" t-as="o">
        <t t-call="web.external_layout">
          <div class="page">
            <t t-if="o.is_duplicate">
              <div style="opacity:0.15; position:absolute; text-align:center; width:95%; margin-top: 70px; -webkit-transform: rotate(-30deg); -moz-transform: rotate(-30deg);">
                <span style="font-size:100px; letter-spacing: 2px;">Duplicata</span>
              </div>
            </t>
            <div class="row">
              <div class="col-6">
                <div>
                  <strong>Prescriber:</strong>
                  <div>
                    <div>
                      <span>Name:</span>
                      <span t-field="o.employee_id"/>
                    </div>
                    <div>
                      <span>Veto order n°:</span>
                      <span t-field="o.employee_id.order_number"/>
                    </div>
                  </div>
                </div>
                <div style="margin-top: 30px;">
                  <h3 class="mt0 float-left text-danger">Prescription n°
                    <span t-field="o.name"/>
                  </h3>
                </div>
                <br/>
                <div class="col-8" style="margin-top: 60px;">
                  <div name="div_sched_date" class="text-center">
                    <strong>Prescription date:</strong>
                    <p t-field="o.consultation_date" t-options="{'format': 'dd/MM/yyyy'}"/>
                  </div>
                </div>
              </div>
              <div class="col-6" name="div_outgoing_address">
                <div t-if="o.partner_id" name="partner_header">
                  <span>
                    <strong>Owner:</strong>
                  </span>
                  <div t-field="o.partner_id"
                       t-options='{"widget": "contact",
                                "fields": ["name", "phone"],
                                "no_marker": True,
                                "phone_icons": True,
                                "email": True
                                }'
                  />
                  <div>
                    <t t-if="o.partner_id.street">
                      <span t-field="o.partner_id.street"/>,
                    </t>
                    <t t-if="o.partner_id.street2">
                      <span t-field="o.partner_id.street2"/>,
                    </t>
                    <t t-if="o.partner_id.city">
                      <span t-field="o.partner_id.city"/>,
                    </t>
                    <t t-if="o.partner_id.zip">
                      <span t-field="o.partner_id.zip"/>,
                    </t>
                    <t t-if="o.partner_id.country_id">
                      <span t-field="o.partner_id.country_id"/>
                    </t>
                  </div>
                </div>
                <br/>
                <div t-if="o.patient_id">
                  <strong>Patient</strong>
                  <div>
                    <span t-field="o.patient_id"/>,
                    <span t-field="o.patient_id.chip_identification"/>
                  </div>
                  <div>
                    Species:
                    <span t-field="o.patient_id.species_id"/>
                  </div>
                  <div>
                    Gender:
                    <span t-field="o.patient_id.gender_id"/>
                  </div>
                  <div>
                    Birthdate:
                    <span t-field="o.patient_id.birthdate_date"/>
                  </div>
                  <div>
                    Weight in kg:
                    <span t-field="o.patient_id.weight"/>
                  </div>
                </div>
              </div>
            </div>
            <br/>
            <t t-set="line_count" t-value="0"/>
            <table class="table table-sm" t-if="o.order_line">
              <thead>
                <tr style="border-bottom: 1px solid rgb(211,211,211);">
                  <th name="item">
                    <strong>Item</strong>
                  </th>
                  <th>
                    <strong>Sale Description</strong>
                  </th>
                  <th>
                    <strong>Indications</strong>
                  </th>
                  <th>
                    <strong>Renewal</strong>
                  </th>
                  <th>
                    <strong>Administration Route</strong>
                  </th>
                  <th>
                    <strong>Initial Qty</strong>
                  </th>
                  <th>
                    <strong>Delivered</strong>
                  </th>
                  <th name="th_serial_number" class="text-center">
                    <strong>Lot Number</strong>
                  </th>
                  <th>
                    <strong>Delivery Date</strong>
                  </th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="o.order_line.filtered(lambda l: l.product_id.type != 'service').sorted(key=lambda l: l.sequence2)" t-as="line">
                  <t t-set="line_count" t-value="line_count + 1"/>
                  <tr>
                    <td>
                      <span t-field="line.sequence2"/>
                    </td>
                    <td>
                      <span t-field="line.description_sale"/>
                    </td>
                    <td>
                      <span t-field="line.description_pickingout"/>
                    </td>
                    <td>
                      <span t-field="line.renewal"/>
                    </td>
                    <td>
                      <span t-field="line.product_id.administration_route_ids"/>
                    </td>
                    <td>
                      <span t-esc="'%.1f'%(line.product_uom_qty)"/>
                    </td>
                    <td>
                      <span t-esc="'%.1f'%(line.qty_delivered)"/>
                    </td>
                    <td/>
                    <td/>
                  </tr>
                  <t t-foreach="line.move_ids.move_line_ids.filtered(lambda l: l.state == 'done' and l.qty_done)" t-as="ml">
                    <tr>
                      <td/>
                      <td/>
                      <td/>
                      <td/>
                      <td/>
                      <td/>
                      <td>
                        <span t-esc="'%.1f'%(ml.qty_done)"/>
                      </td>
                      <td>
                        <t t-if="ml.lot_id">
                          <span t-field="ml.lot_id"/>
                        </t>
                      </td>
                      <td>
                        <span t-field="ml.date" t-options="{'format': 'dd/MM/yyyy'}"/>
                      </td>
                    </tr>
                  </t>
                </t>
              </tbody>
            </table>
            <div>
              <br/>
              <span>This order contains
                <t t-esc="line_count"/>line(s)
              </span>
              <br/>
            </div>
            <div class="row">
              <div class="col-7"/>
              <div class="col-5 col-offset-8 text-center">
                <br/>
                <div>
                  <span>Signature</span>
                </div>
                <div>
                  <t t-if="o.employee_id">
                    <span t-field="o.employee_id"/>,
                  </t>
                  <t t-if="o.employee_id.order_number">
                    <span t-field="o.employee_id.order_number"/>,
                  </t>
                </div>
              </div>
            </div>
            <t t-if="not o.is_duplicate">
              <t t-set="duplicate" t-value="o.make_duplicate()"/>
            </t>
          </div>
        </t>
      </t>
    </t>
  </template>
</odoo>