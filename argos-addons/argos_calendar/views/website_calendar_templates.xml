<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="appointment_form_inherit" inherit_id="website_calendar.appointment_form"
            name="Website Appointment: Your Data">
    <xpath expr="//form/div[@class='form-group row col-xl-8'][1]" position="before">
      <div class="form-group row col-xl-8">
        <label class="col-md-4 col-form-label" for="new_duration">Duration</label>
        <div class="col-md-8">
          <input type="text" class="form-control" name="new_duration"
                 t-att-value="'%02d:%02d' % (int(appointment_type.appointment_duration),int(appointment_type.appointment_duration % 1 * 60) if (appointment_type.appointment_duration % 1) else 0)"
                 readonly="1"/>
        </div>
      </div>
    </xpath>
    <xpath expr="//form/div[@class='form-group row col-xl-8'][5]" position="after">
      <div class="form-group row col-xl-8">
        <label class="col-md-4 col-form-label" for="available_slot_alert">Avalaible slot alert</label>
        <div class="col-md-8">
          <div class="checkbox">
            <label>
              <input type="checkbox" class="form-control" name="available_slot_alert"/>
            </label>
          </div>
        </div>
      </div>
    </xpath>
  </template>

  <template id="appointment_validated_inherit" inherit_id="website_calendar.appointment_validated">
    <xpath expr="//div[@class='row'][1]/div[@class='col-md-9'][1]/div[@class='row'][2]" position="replace">
      <div class="row">
        <div class="col-md-2 text-right">
          <label>Duration:</label>
        </div>
        <div class="col-md-10">
          <span t-field="event.allocated_hours" t-options="{'widget': 'float_time'}"/>
          hour<t t-if="event.allocated_hours>=2">s</t>
        </div>
      </div>
    </xpath>
    <xpath expr="//div[@class='row'][1]/div[@class='col-md-9'][1]/div[@class='row'][5]" position="after">
      <div class="row">
        <div class="col-md-2 text-right">
          <label>Available appointment notification:</label>
        </div>
        <div class="col-md-10">
          <div class="checkbox">
            <label>
              <input type="checkbox" t-att-checked="event.available_slot_alert" disabled="disabled"/>
            </label>
          </div>
        </div>
      </div>
    </xpath>
  </template>

  <template id="portal_my_home" name="Portal My Home: Planning" inherit_id="portal.portal_my_home" priority="40">
    <xpath expr="//div[hasclass('o_portal_docs')]" position="inside">
      <t t-if="appointment_count" t-call="portal.portal_docs_entry">
        <t t-set="title">Appointments</t>
        <t t-set="url" t-value="'/my/appointments'"/>
        <t t-set="count" t-value="appointment_count"/>
      </t>
    </xpath>
  </template>

  <template id="portal_my_plannings" name="My Plannings">
    <t t-call="portal.portal_layout">
      <t t-set="breadcrumbs_searchbar" t-value="True"/>
      <t t-call="portal.portal_searchbar">
        <t t-set="title">Plannings</t>
      </t>
      <t t-if="not plannings">
        <div class="alert alert-warning mt8" role="alert">
          There are no plannings.
        </div>
      </t>
      <t t-if="plannings" t-call="portal.portal_table">
        <thead>
          <tr class="active">
            <th>Start date</th>
            <th>Duration</th>
            <th>Note</th>
            <th>State</th>
            <th>Available appointment notification</th>
          </tr>
        </thead>
        <tbody>
          <tr t-foreach="plannings" t-as="planning">
            <td>
              <t t-if="planning.calendar_event_ids">
                <a t-attf-href="/my/appointment/#{planning.calendar_event_ids[0].access_token}?{{ keep_query() }}">
                  <span t-field="planning.start_datetime"/>
                </a>
              </t>
              <t t-else="">
                <span t-field="planning.start_datetime"/>
              </t>
            </td>
            <td>
              <span t-field="planning.allocated_hours" t-options="{'widget': 'float_time'}"/>
              hour<t t-if="planning.allocated_hours>=2">s</t>
            </td>
            <td>
              <span t-field="planning.name"/>
            </td>
            <td class="text-right">
              <span t-field="planning.state"/>
            </td>
            <td>
              <input type="checkbox" t-att-checked="planning.available_slot_alert" disabled="disabled"/>
            </td>
          </tr>
        </tbody>
      </t>
    </t>
  </template>

  <template id="portal_layout" name="Portal layout: event menu entry" inherit_id="portal.portal_breadcrumbs"
            priority="40">
    <xpath expr="//ol[hasclass('o_portal_submenu')]" position="inside">
      <li t-if="page_name == 'event' or event" t-attf-class="breadcrumb-item #{'active ' if not event else ''}">
        <a t-if="event" t-attf-href="/my/appointments?{{ keep_query() }}">Appointments</a>
        <t t-else="">Appointments</t>
      </li>
      <li t-if="event" class="breadcrumb-item active">
        <t t-esc="event.name"/>
      </li>
    </xpath>
  </template>

  <template id="appointment_info" name="Website Appointment: Appointment Confirmed">
    <t t-call="portal.portal_layout">
      <div class="container o_website_calendar">
        <div class="card-body">
          <h1 class="o_page_header">Appointment:
            <span t-esc="event.name"/>
          </h1>
          <div class="alert alert-info" t-if="message=='new'" role="status">
            <p>
              <strong>Your appointment has been successfully booked!</strong>
            </p>
          </div>
          <div class="alert alert-danger" t-if="message=='no-cancel'" role="alert">
            <p>
              <strong>Your appointment is in less than
                <t t-esc="event.appointment_type_id.min_cancellation_hours"/>
                hours from now!
              </strong>
              <br/>
              It's too late to cancel online, please contact the attendees another way if you really can't make it.
            </p>
          </div>
          <div class="row">
            <t t-if="event.appointment_type_id">
              <div t-raw="event.appointment_type_id.message_confirmation" style="margin-bottom:10px;"/>
            </t>
            <div class="col-md-9">
              <div class="row">
                <div class="col-md-2 text-right">
                  <label>When:</label>
                </div>
                <div class="col-md-10">
                  <t t-esc="datetime_start"/>
                  <br/>
                  <i class="text-muted">(timezone:<t t-esc="request.session.timezone"/>)
                  </i>
                </div>
              </div>
              <div class="row">
                <div class="col-md-2 text-right">
                  <label>Duration:</label>
                </div>
                <div class="col-md-10">
                  <span t-field="event.allocated_hours" t-options="{'widget': 'float_time'}"/>
                  hour<t t-if="event.allocated_hours>=2">s</t>
                </div>
              </div>
              <div t-if="event.location" class="row">
                <div class="col-md-2 text-right">
                  <label>Location:</label>
                </div>
                <div class="col-md-10">
                  <t t-esc="event.location"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-2 text-right">
                  <label>Attendees:</label>
                </div>
                <div class="col-md-10">
                  <div t-foreach="event.attendee_ids" t-as="attendee">
                    <t t-esc="attendee.common_name"/>
                    <span t-if="attendee.state=='accepted'" class="fa fa-check text-success" title="Confirmed"
                          role="img" aria-label="Confirmed"/>
                    <span t-if="attendee.state=='declined'" class="fa fa-times text-danger" title="Declined" role="img"
                          aria-label="Declined"/>
                  </div>
                </div>
              </div>
              <div t-if="event.description" class="row">
                <div class="col-md-2 text-right">
                  <label>Description:</label>
                </div>
                <div class="col-md-10">
                  <div t-field="event.description"/>
                </div>
              </div>
              <div class="row">
                <div class="col-md-2 text-right">
                  <label>Available appointment notification:</label>
                </div>
                <div class="col-md-10">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" t-att-checked="event.available_slot_alert" disabled="disabled"/>
                    </label>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <a role="button" class="btn btn-block btn-primary"
                 t-attf-href="/website/calendar/ics/#{event.access_token}.ics">
                <i class="fa fa-fw fa-arrow-right"></i>Add to iCal/Outlook
              </a>
              <a role="button" class="btn btn-primary btn-block" t-att-href="google_url">
                <i class="fa fa-fw fa-arrow-right"></i>Add to Google Calendar
              </a>
              <t t-if="event.appointment_type_id">
                <br/>
                <br/>
                <a role="button" class="btn btn-danger btn-block"
                   t-attf-href="/website/calendar/cancel/#{event.access_token}">
                  <i class="fa fa-fw fa-times"></i>Cancel / Reschedule
                </a>
              </t>
            </div>
          </div>
        </div>
      </div>
    </t>
  </template>

  <template id="replanning" name="Website Appointment Replanning">
    <t t-call="website.layout">
      <div id="wrap" class="o_website_calendar">
        <div class="oe_structure container mb128">
          <h1 class="o_page_header mt32">Appointment replanning</h1>
          <div class="alert alert-danger mt16" role="alert">
            <p>
              <strong>Appointment replanning failed!</strong>
              The selected timeslot is not available anymore.
              Someone has booked the same time slot a few
              seconds before you.
            </p>
          </div>
          <div class="clearfix"/>
        </div>
      </div>
    </t>
  </template>

  <template id="replanning_form" name="Website Replanning: Your Data">
    <t t-call="website.layout">
      <div id="wrap" class="o_website_calendar">
        <div class="oe_structure container mb128 o_website_calendar_form">
          <h2 class="o_page_header mt32">Confirm your details</h2>
          <p>
            <span t-field="appointment_type.name"/>
            on
            <strong t-esc="datetime_locale"/>
          </p>
          <form class="mt32 appointment_submit_form"
                t-attf-action="/website/replanning/#{appointment.id}/#{partner_appointment.id}/submit"
                method="POST">
            <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
            <div class="form-group row col-xl-8">
              <label class="col-md-4 col-form-label" for="new_duration">Duration</label>
              <div class="col-md-8">
                <input type="text" class="form-control" name="new_duration"
                       t-att-value="'%02d:%02d' % (int(appointment.allocated_hours),int(appointment.allocated_hours % 1 * 60) if (appointment.allocated_hours % 1) else 0)"
                       readonly="1"/>
              </div>
            </div>
            <div class="form-group row col-xl-8">
              <label for="name" class="col-md-4 col-form-label">Your Name</label>
              <div class="col-md-8">
                <input type="char" class="form-control" name="name" required="1"
                       t-att-value="'name' in partner_data and partner_data['name']"/>
              </div>
            </div>
            <div class="form-group row col-xl-8">
              <label class="col-md-4 col-form-label" for="country_id">Your Country</label>
              <div class="col-md-8">
                <select name="country_id" class="form-control" required="1" id="country_field">
                  <t t-if="'country_id' not in partner_data or not partner_data['country_id']">
                    <option disabled="1" selected="1">-- select a country --</option>
                  </t>
                  <t t-foreach="countries or []" t-as="country">
                    <option t-att-value="country.id"
                            t-att-data-phone-code="country.phone_code and ('+'+str(country.phone_code)+' ') or None"
                            t-att-selected="partner_data.get('country_id') and country.id == partner_data['country_id'][0]">
                      <t t-esc="country.name"/>
                    </option>
                  </t>
                </select>
              </div>
            </div>
            <div class="form-group row col-xl-8">
              <label for="email" class="col-md-4 col-form-label">Your Email</label>
              <div class="col-md-8">
                <input type="email" class="form-control" name="email"
                       t-att-value="'email' in partner_data and partner_data['email']" required="1"/>
              </div>
            </div>
            <div class="form-group row col-xl-8">
              <label for="phone" class="col-md-4 col-form-label">Your Phone</label>
              <div class="col-md-8">
                <input type="tel" class="form-control" name="phone" placeholder="+1 (650) 691-3277" required="1"
                       id="phone_field" t-att-value="'mobile' in partner_data and partner_data['mobile']"/>
              </div>
            </div>
            <div class="form-group row col-xl-8">
              <label class="col-md-4 col-form-label" for="available_slot_alert">Avalaible slot alert</label>
              <div class="col-md-8">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" class="form-control" name="available_slot_alert"/>
                  </label>
                </div>
              </div>
            </div>
            <div class="form-group row">
              <div class="offset-md-2 col-md-10">
                <button type="submit" class="btn btn-primary">Confirm Appointment
                  <span class="fa fa-arrow-right"/>
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </t>
  </template>
</odoo>