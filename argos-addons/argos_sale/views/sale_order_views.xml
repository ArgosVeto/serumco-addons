<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>

    <record model="ir.actions.act_window" id="action_add_subline">
      <field name="name">Add subline</field>
      <field name="type">ir.actions.act_window</field>
      <field name="res_model">sale.order.line</field>
      <field name="view_mode">form</field>
      <field name="context">{'form_view_ref': 'argos_sale.sale_order_line_view_form',
                             'default_pack_parent_line_id': active_id, 'from_add_subline': True}</field>
      <field name="target">new</field>
    </record>

    <record id="consultation_view_order_form" model="ir.ui.view">
      <field name="name">consultation.sale.order.form</field>
      <field name="model">sale.order</field>
      <field name="priority">20</field>
      <field name="arch" type="xml">
        <form string="Consultation">
          <header>
            <button name="button_end_consultation"
                    string="End" type="object" class="btn-primary"
                    attrs="{'invisible': [('argos_state', 'not in', ['in_progress'])]}"/>
            <button name="action_create_invoice" string="Create Invoice"
                    type="object" context="{'default_advance_payment_method': 'percentage'}"
                    attrs="{'invisible': ['|', ('invoice_status', '!=', 'no'), '|', ('state', '!=', 'sale'), ('is_consultation', '=', True)]}"
                    class="btn-primary"/>
            <button name="action_create_invoice" string="Create Invoice" type="object"
                    attrs="{'invisible': ['|', ('invoice_status', '!=', 'to invoice'), ('is_consultation', '=', True)]}"/>
            <button name="action_confirm" id="action_confirm"
                    string="Confirm" class="btn-primary" type="object"
                    attrs="{'invisible': [('state', 'not in', ['sent'])]}"/>
            <button name="action_confirm"
                    string="Confirm" type="object"
                    attrs="{'invisible': [('state', 'not in', ['draft'])]}"/>
            <button name="button_confirm_edition_sale_completed"
                    string="Modify consultation completed" type="object"
                    attrs="{'invisible': [('state', 'not in', ['sent', 'sale'])]}"
            />
            <button name="%(argos_sale.action_refer_consultation_to)d"
                    string="Refer To" type="action"
            />
            <button name="button_edit_incineris" string="Incineris Convention" type="object"
                    attrs="{'invisible': ['|', ('is_incineris', '=', False), ('conv_key', '!=', False)]}"/>
            <field name="argos_state" widget="statusbar" statusbar_visible="in_progress,consultation_done"/>
          </header>
          <sheet>
            <div class="oe_button_box" name="button_box">
              <button name="action_view_invoice"
                      type="object"
                      class="oe_stat_button"
                      icon="fa-pencil-square-o"
                      attrs="{'invisible': [('invoice_count', '=', 0)]}">
                <field name="invoice_count" widget="statinfo" string="Invoices"/>
              </button>
              <button type="object"
                      name="button_referrals_view"
                      class="oe_stat_button"
                      icon="fa-newspaper-o"
                      attrs="{'invisible': [('refer_count', '=', 0)]}" >
                <field name="refer_count" widget="statinfo" string="Referrals"/>
              </button>
              <button attrs="{'invisible': [('arrival_time', '=', False)]}">
                <field name="arrival_time" widget="timer" class="text-danger h2 pull-right mr-4 font-weight-bold"/>
              </button>
            </div>
            <div class="oe_title">
              <h1>
                <field name="name"/>
              </h1>
            </div>
            <group>
              <group>
                <field name="is_consultation" invisible="1"/>
                <field name="conv_key" invisible="1"/>
                <field name="is_incineris" invisible="1"/>
                <field name="origin_order_id" attrs="{'invisible': [('origin_order_id', '=', False)]}"/>
                <field name="invoice_status" invisible="1"/>
                <field name="state" invisible="1"/>
                <field name="company_id" invisible="1"/>
                <field name="pickup_time" invisible="1"/>
                <field name="patient_id" required="1" context="{'form_view_ref': 'argos_contact.res_partner_view_form',
                   'tree_view_ref': 'argos_contact.res_partner_view_tree', 'default_contact_type': 'patient'}"/>
                <field name="species_id" string="Species"/>
                <field name="race_id"/>
                <field name="gender_id"/>
                <field name="age"/>
                <field name="weight"/>
                <field name="pathology_ids" widget="many2many_tags" string="Pathologies &amp; Intolerance"/>
                <field name="consultation_type_id" string="Reason For Appointment"/>
                <field name="is_referral" invisible="1"/>
                <field name="referent_partner_id" attrs="{'invisible': [('is_referral', '=', False)]}"/>
                <field name="customer_observation"/>
                <field name="canvas_id" context="{'default_is_canvas': True}"/>
                <field name="observation"/>
              </group>
              <group>
                <field name="consultation_date"/>
                <field name="pricelist_id" groups="product.group_product_pricelist"
                       options="{'no_open':True,'no_create': True}"/>
                <field name="employee_id" string="Seen By" context="{'default_is_veterinary': True}"/>
                <field name="partner_id"/>
                <field name="partner_patient_ids" widget="many2many_tags"/>
                <field name="operating_unit_id" string="Clinical"/>
                <field name="diagnostic_ids" widget="many2many_tags" context="{'default_type': 'diagnostic'}"/>
                <field name="hypothese_ids" widget="many2many_tags" context="{'default_type': 'hypothese'}"/>
              </group>
            </group>
            <notebook>
              <page name="command_lines" string="Command Lines">
                <field name="max_line_sequence" invisible="1"/>
                <field name="order_line" widget="section_and_note_one2many" mode="tree,kanban"
                       attrs="{'readonly': [('state', 'in', ('done','cancel'))]}" context="{'default_sequence': max_line_sequence}">
                  <form>
                    <field name="display_type" invisible="1"/>
                    <field name="sequence" invisible="1"/>
                    <field name="product_uom_category_id" invisible="1"/>
                    <group>
                      <group attrs="{'invisible': [('display_type', '!=', False)]}">
                        <field name="product_updatable" invisible="1"/>
                        <field name="sequence" invisible="1"/>
                        <field name="product_id"
                               domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                               context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'company_id': parent.company_id}"
                               attrs="{'readonly': [('product_updatable', '=', False)], 'required': [('display_type', '=', False)],}"
                               force_save="1"
                               widget="many2one_barcode"
                        />
                        <field name="invoice_status" invisible="1"/>
                        <field name="qty_to_invoice" invisible="1"/>
                        <field name="qty_delivered_manual" invisible="1"/>
                        <field name="qty_delivered_method" invisible="1"/>
                        <field name="price_total" invisible="1"/>
                        <field name="price_tax" invisible="1"/>
                        <field name="price_subtotal" invisible="1"/>
                        <label for="product_uom_qty"/>
                        <div class="o_row" name="ordered_qty">
                          <field
                                context="{'partner_id':parent.partner_id, 'quantity':product_uom_qty, 'pricelist':parent.pricelist_id, 'uom':product_uom, 'uom_qty_change':True, 'company_id': parent.company_id}"
                                name="product_uom_qty"/>
                          <field
                                name="product_uom"
                                force_save="1"
                                groups="uom.group_uom"
                                class="oe_no_button"
                                attrs="{
                                    'readonly': [('state', 'in', ('sale', 'done', 'cancel'))],
                                    'required': [('display_type', '=', False)],
                                }"
                          />
                        </div>
                        <label for="qty_delivered" string="Delivered"
                               attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                        <div name="delivered_qty" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}">
                          <field name="qty_delivered" attrs="{'readonly': [('qty_delivered_method', '!=', 'manual')]}"/>
                        </div>
                        <label for="qty_invoiced" string="Invoiced"
                               attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                        <div name="invoiced_qty" attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}">
                          <field name="qty_invoiced"
                                 attrs="{'invisible': [('parent.state', 'not in', ['sale', 'done'])]}"/>
                        </div>
                        <field name="price_unit" readonly="1"/>
                        <field name="tax_id" widget="many2many_tags" options="{'no_create': True}"
                               context="{'search_view_ref': 'account.account_tax_view_search'}"
                               domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                               attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"/>
                        <label for="discount"/>
                        <div name="discount">
                          <field name="is_antibiotic" invisible="1"/>
                          <field name="is_critical_antibiotic" invisible="1"/>
                          <field name="discount" class="oe_inline" attrs="{'readonly': [('is_antibiotic', '=', True)]}"/>
                          %%
                        </div>
                        <field name="sequence" invisible="1"/>
                      </group>
                      <group attrs="{'invisible': [('display_type', '!=', False)]}">
                        <label for="customer_lead"/>
                        <div name="lead">
                          <field name="customer_lead" class="oe_inline"/>
                          days
                        </div>
                        <field name="analytic_tag_ids" widget="many2many_tags" groups="analytic.group_analytic_tags"
                               options="{'color_field': 'color'}"
                               domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"/>
                      </group>
                    </group>
                    <label for="name" string="Description" attrs="{'invisible': [('display_type', '!=', False)]}"/>
                    <label for="name" string="Section Name (eg. Products, Services)"
                           attrs="{'invisible': [('display_type', '!=', 'line_section')]}"/>
                    <label for="name" string="Note" attrs="{'invisible': [('display_type', '!=', 'line_note')]}"/>
                    <field name="name"/>
                    <div name="invoice_lines" groups="base.group_no_one"
                         attrs="{'invisible': [('display_type', '!=', False)]}">
                      <label for="invoice_lines"/>
                      <field name="invoice_lines"/>
                    </div>
                    <field name="state" invisible="1"/>
                    <field name="company_id" invisible="1"/>
                  </form>
                  <tree
                        string="Sales Order Lines"
                        editable="bottom"
                        decoration-info="(not display_type and invoice_status == 'to invoice')"
                  >
                    <control>
                      <create name="add_product_control" string="Add a product"/>
                      <create name="add_section_control" string="Add a section"
                              context="{'default_display_type': 'line_section'}"/>
                      <create name="add_note_control" string="Add a note"
                              context="{'default_display_type': 'line_note'}"/>
                    </control>

                    <field name="sequence" widget="handle"/>
                    <field name="display_type" invisible="1"/>
                    <field name="product_uom_category_id" invisible="1"/>
                    <field name="product_updatable" invisible="1"/>
                    <field name="sequence2" string="Item"/>
                    <field
                          name="product_id"
                          attrs="{
                              'readonly': [('product_updatable', '=', False)],
                              'required': [('display_type', '=', False)],
                          }"
                          options="{'no_open': True}"
                          force_save="1"
                          context="{
                              'partner_id': parent.partner_id,
                              'quantity': product_uom_qty,
                              'pricelist': parent.pricelist_id,
                              'uom':product_uom,
                              'company_id': parent.company_id,
                              'default_lst_price': price_unit,
                              'default_description_sale': name
                          }"
                          domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                          widget="product_configurator"
                    />
                    <field name="product_template_id"
                           string="Product"
                           invisible="1"
                           attrs="{
                                'readonly': [('product_updatable', '=', False)],
                                'required': [('display_type', '=', False)],
                            }"
                           options="{'no_open': True}"
                           context="{
                                'partner_id': parent.partner_id,
                                'quantity': product_uom_qty,
                                'pricelist': parent.pricelist_id,
                                'uom':product_uom,
                                'company_id': parent.company_id,
                                'default_list_price': price_unit,
                                'default_description_sale': name
                            }"
                           domain="[('sale_ok', '=', True), '|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                           widget="product_configurator"/>
                    <field name="name" widget="section_and_note_text" optional="show"/>
                    <field
                          name="analytic_tag_ids"
                          optional="hide"
                          groups="analytic.group_analytic_tags"
                          widget="many2many_tags"
                          options="{'color_field': 'color'}"
                          domain="['|', ('company_id', '=', False), ('company_id', '=', parent.company_id)]"
                    />
                    <field
                          name="product_uom_qty"
                          context="{
                              'partner_id': parent.partner_id,
                              'quantity': product_uom_qty,
                              'pricelist': parent.pricelist_id,
                              'uom': product_uom,
                              'company_id': parent.company_id
                          }"
                    />
                    <field
                          name="qty_delivered"
                          string="Delivered"
                          attrs="{
                              'column_invisible': [('parent.state', 'not in', ['sale', 'done'])],
                              'readonly': [('qty_delivered_method', '!=', 'manual')]
                          }"
                          optional="show"
                    />
                    <field name="qty_delivered_manual" invisible="1"/>
                    <field name="qty_delivered_method" invisible="1"/>
                    <field
                          name="qty_invoiced"
                          string="Invoiced"
                          attrs="{'column_invisible': [('parent.state', 'not in', ['sale', 'done'])]}"
                          optional="show"
                    />
                    <field name="qty_to_invoice" invisible="1"/>
                    <field
                          name="product_uom"
                          force_save="1"
                          string="UoM"
                          attrs="{
                              'readonly': [('state', 'in', ('sale','done', 'cancel'))],
                              'required': [('display_type', '=', False)],
                          }"
                          context="{'company_id': parent.company_id}"
                          groups="uom.group_uom"
                          options='{"no_open": True}'
                          optional="show"
                    />
                    <field
                          name="customer_lead"
                          optional="hide"
                          attrs="{'readonly': [('parent.state', 'not in', ['draft', 'sent'])]}"
                    />
                    <field
                          name="price_unit"
                          readonly="1"
                    />
                    <field
                          name="tax_id"
                          widget="many2many_tags"
                          options="{'no_create': True}"
                          domain="[('type_tax_use','=','sale'),('company_id','=',parent.company_id)]"
                          attrs="{'readonly': [('qty_invoiced', '&gt;', 0)]}"
                          optional="show"
                    />
                    <field name="is_antibiotic" invisible="1"/>
                    <field name="discount" string="Disc.%" optional="show" attrs="{'readonly': [('is_antibiotic', '=', True)]}"/>
                    <field name="price_subtotal" widget="monetary"
                           groups="account.group_show_line_subtotals_tax_excluded"/>
                    <field name="price_total" widget="monetary"
                           groups="account.group_show_line_subtotals_tax_included"/>
                    <field name="state" invisible="1"/>
                    <field name="invoice_status" invisible="1"/>
                    <field name="currency_id" invisible="1"/>
                    <field name="price_tax" invisible="1"/>
                    <field name="company_id" invisible="1"/>
                    <field name="is_add_subline_allowed" invisible="1"/>
                    <button name="%(argos_sale.action_add_subline)d" string="Add subline" icon="fa-plus" type="action"
                            attrs="{'invisible': ['|', ('is_add_subline_allowed', '=', False), ('parent.argos_state', 'in', ['consultation_done'])]}"/>
                  </tree>
                  <kanban class="o_kanban_mobile">
                    <field name="name"/>
                    <field name="product_id"/>
                    <field name="product_uom_qty"/>
                    <field name="product_uom" groups="uom.group_uom"/>
                    <field name="price_subtotal"/>
                    <field name="price_tax" invisible="1"/>
                    <field name="price_total" invisible="1"/>
                    <field name="price_unit"/>
                    <field name="display_type"/>
                    <field name="tax_id" invisible="1"/>
                    <field name="company_id" invisible="1"/>
                    <templates>
                      <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_card oe_kanban_global_click {{ record.display_type.raw_value ? 'o_is_' + record.display_type.raw_value : '' }}">
                          <t t-if="!record.display_type.raw_value">
                            <div class="row">
                              <div class="col-8">
                                <strong>
                                  <span>
                                    <t t-esc="record.product_id.value"/>
                                  </span>
                                </strong>
                              </div>
                              <div class="col-4">
                                <strong>
                                  <span class="float-right text-right">
                                    <t t-esc="record.price_subtotal.value"/>
                                  </span>
                                </strong>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-12 text-muted">
                                <span>
                                  Quantity:
                                  <t t-esc="record.product_uom_qty.value"/>
                                  <t t-esc="record.product_uom.value"/>
                                </span>
                              </div>
                            </div>
                            <div class="row">
                              <div class="col-12 text-muted">
                                <span>
                                  Unit Price:
                                  <t t-esc="record.price_unit.value"/>
                                </span>
                              </div>
                            </div>
                          </t>
                          <t t-if="record.display_type.raw_value === 'line_section' || record.display_type.raw_value === 'line_note'">
                            <div class="row">
                              <div class="col-12">
                                <span>
                                  <t t-esc="record.name.value"/>
                                </span>
                              </div>
                            </div>
                          </t>
                        </div>
                      </t>
                    </templates>
                  </kanban>
                </field>
                <group name="note_group" col="6">
                  <group colspan="4">
                    <field name="note" nolabel="1" placeholder="Terms and conditions..."/>
                  </group>
                  <group class="oe_subtotal_footer oe_right" colspan="2" name="sale_total">
                    <field name="amount_untaxed" widget='monetary' options="{'currency_field': 'currency_id'}"/>
                    <field name="amount_tax" widget='monetary' options="{'currency_field': 'currency_id'}"/>
                    <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                      <label for="amount_total"/>
                    </div>
                    <field name="amount_total" nolabel="1" class="oe_subtotal_footer_separator" widget='monetary'
                           options="{'currency_field': 'currency_id'}"/>
                  </group>
                  <div class="oe_clear"/>
                </group>
              </page>
              <page name="analysis_lines" string="Analysis"/>
              <page name="imagery_lines" string="Imagery"/>
            </notebook>
          </sheet>
          <div class="oe_chatter">
            <field name="message_follower_ids" widget="mail_followers"/>
            <field name="activity_ids" widget="mail_activity"/>
            <field name="message_ids" widget="mail_thread"/>
          </div>
        </form>
      </field>
    </record>

    <record id="consultation_view_order_tree" model="ir.ui.view">
      <field name="name">consultation.sale.order.tree</field>
      <field name="model">sale.order</field>
      <field name="priority">20</field>
      <field name="arch" type="xml">
        <tree string="Consultations">
          <field name="consultation_date"/>
          <field name="partner_id"/>
          <field name="patient_id" invisible="context.get('from_patient', False)"/>
          <field name="employee_id"/>
          <field name="diagnostic_ids" widget="many2many_tags"/>
          <field name="hypothese_ids" widget="many2many_tags"/>
          <field name="company_id"/>
          <field name="operating_unit_id" string="Operating Unit"/>
          <field name="attachment_ids" widget="many2many_binary" invisible="not context.get('from_patient', False)"/>
          <field name="state" invisible="1"/>
          <field name="argos_state" invisible="1"/>
        </tree>
      </field>
    </record>

    <record id="model_sale_order_action_reprint_convention" model="ir.actions.server">
      <field name="name">Reprint Convention</field>
      <field name="model_id" ref="sale.model_sale_order"/>
      <field name="binding_model_id" ref="sale.model_sale_order"/>
      <field name="binding_view_types">form</field>
      <field name="state">code</field>
      <field name="code">action = records.reprint_convention()</field>
    </record>

    <record id="action_consultations" model="ir.actions.act_window">
      <field name="name">Consultations</field>
      <field name="type">ir.actions.act_window</field>
      <field name="res_model">sale.order</field>
      <field name="view_mode">tree,form</field>
      <field name="context">{'default_is_consultation': True,
                             'default_argos_state': 'in_progress',
                             'tree_view_ref': 'argos_sale.consultation_view_order_tree',
                             'form_view_ref': 'argos_sale.consultation_view_order_form'}</field>
      <field name="domain">[('is_consultation', '=', True)]</field>
    </record>

    <menuitem id="menu_consultation"
              name="Consultations"
              action="action_consultations"
              parent="sale.sale_order_menu"
              sequence="2"/>

    <record id="sale.action_quotations_with_onboarding" model="ir.actions.act_window">
      <field name="domain">[('is_consultation', '=', False)]</field>
    </record>

    <record id="sale.action_orders" model="ir.actions.act_window">
      <field name="domain">[('state', 'not in', ('draft', 'sent', 'cancel')), ('is_consultation', '=', False)]</field>
    </record>

    <record id="consultation_view_order_form_inherit" model="ir.ui.view">
      <field name="name">consultation.view.order.form.inherit</field>
      <field name="model">sale.order</field>
      <field name="inherit_id" ref="argos_sale.consultation_view_order_form"/>
      <field name="arch" type="xml">
        <xpath expr="//tree/field[@name='product_template_id']" position="attributes">
          <attribute name="invisible">0</attribute>
        </xpath>
        <xpath expr="//tree/field[@name='product_template_id']" position="after">
          <widget name="tooltips_widget" width="0.1"/>
          <field name="is_critical_antibiotic" invisible="1"/>
          <field name="tooltip_text" invisible="1"/>
          <field name="has_promotion" invisible="1"/>
          <field name="coupon_program_ids" invisible="1"/>
        </xpath>
        <xpath expr="//tree/field[@name='product_template_id']" position="after">
          <field name="product_template_attribute_value_ids" invisible="1"/>
          <field name="product_custom_attribute_value_ids" invisible="1">
            <tree>
              <field name="custom_product_template_attribute_value_id"/>
              <field name="custom_value"/>
            </tree>
          </field>
          <field name="product_no_variant_attribute_value_ids" invisible="1"/>
          <field name="is_configurable_product" invisible="1"/>
        </xpath>
        <xpath expr="//tree/field[@name='product_id']" position="attributes">
          <attribute name="invisible">1</attribute>
        </xpath>
      </field>
    </record>

    <record model="ir.actions.act_window" id="action_open_sales">
      <field name="name">Sales</field>
      <field name="type">ir.actions.act_window</field>
      <field name="res_model">sale.order</field>
      <field name="view_id" ref="sale.view_sale_order_graph"/>
      <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
    </record>

    <record id="view_quotation_tree_argos" model="ir.ui.view">
        <field name="name">view_quotation_tree_argos</field>
        <field name="model">sale.order</field>
        <field name="inherit_id" ref="sale.view_quotation_tree"/>
        <field name="arch" type="xml">
          <xpath expr="//field[@name='state']" position="after">
            <button icon="fa-info-circle"
                    name="compute_api_information"
                    type="object"/>
          </xpath>
        </field>
    </record>

    <record id="view_order_tree_argos" model="ir.ui.view">
      <field name="name">view_order_tree_argos</field>
      <field name="model">sale.order</field>
      <field name="inherit_id" ref="sale.view_order_tree"/>
      <field name="arch" type="xml">
        <xpath expr="//field[@name='state']" position="after">
          <button icon="fa-info-circle"
                  name="compute_api_information"
                  type="object"/>
        </xpath>
      </field>
    </record>
  </data>
</odoo>